# 智能教学平台测试文档

## 文档信息

- **项目名称**：智能教学平台
- **文档版本**：v1.0.0
- **创建日期**：2026年1月28日
- **最后更新**：2026年1月28日
- **维护者**：开发团队

---

## 目录

1. [测试概述](#测试概述)
2. [测试环境](#测试环境)
3. [功能测试](#功能测试)
4. [API测试](#api测试)
5. [性能测试](#性能测试)
6. [安全测试](#安全测试)
7. [测试数据准备](#测试数据准备)
8. [常见问题与解决方案](#常见问题与解决方案)
9. [测试回退与恢复](#测试回退与恢复)

---

## 测试概述

### 测试目标

本文档旨在为智能教学平台提供完整的测试指南，确保系统各模块功能正常、性能稳定、安全可靠。

### 测试范围

- ✅ 用户认证与授权
- ✅ 课程管理
- ✅ 问卷/试卷创建与管理
- ✅ 学生答题与评分
- ✅ 教师仪表盘与数据统计
- ✅ AI问答系统
- ✅ 向量数据库集成
- ✅ 文档解析与知识库构建

### 测试策略

- **单元测试**：针对独立函数和方法
- **集成测试**：测试模块间的交互
- **端到端测试**：模拟真实用户场景
- **性能测试**：负载和压力测试
- **安全测试**：漏洞扫描和权限验证

---

## 测试环境

### 环境配置

#### 开发环境
```yaml
操作系统: Windows 10/11, macOS, Linux
Python版本: 3.9+
Node.js版本: 16+
数据库: PostgreSQL 14+
向量数据库: ChromaDB
```

#### 测试工具
```yaml
后端测试:
  - pytest (单元测试)
  - pytest-asyncio (异步测试)
  - httpx (API测试客户端)
  - pytest-cov (代码覆盖率)

前端测试:
  - Jest (单元测试)
  - React Testing Library (组件测试)
  - Cypress (E2E测试)

API测试:
  - Postman
  - curl
  - httpie
```

### 环境搭建

#### 1. 安装依赖

**后端依赖**
```bash
cd backend
pip install -r requirements.txt
pip install pytest pytest-asyncio pytest-cov httpx
```

**前端依赖**
```bash
cd frontend
npm install
npm install --save-dev jest @testing-library/react @testing-library/jest-dom
```

#### 2. 配置测试数据库

创建独立的测试数据库，避免影响开发数据：

```bash
# 使用psql创建测试数据库
psql -U postgres
CREATE DATABASE teaching_platform_test;
\q

# 初始化测试数据库
psql -U postgres -d teaching_platform_test -f backend/database/init.sql
```

#### 3. 环境变量配置

创建 `.env.test` 文件：

```env
# 数据库配置
DATABASE_URL=postgresql://postgres:password@localhost:5432/teaching_platform_test
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_NAME=teaching_platform_test
DATABASE_USER=postgres
DATABASE_PASSWORD=your_password

# 向量数据库配置
CHROMA_DB_PATH=./test_data/chroma_db

# AI服务配置
OPENAI_API_KEY=your_test_api_key
OPENAI_API_BASE=https://api.openai.com/v1

# JWT配置
JWT_SECRET_KEY=test_secret_key_change_in_production
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# 应用配置
DEBUG=true
TESTING=true
```

---

## 功能测试

### 1. 用户认证模块

#### 1.1 用户注册

**测试用例：TC-AUTH-001**

| 项目 | 内容 |
|------|------|
| 测试描述 | 验证学生用户注册功能 |
| 前置条件 | 系统正常运行，数据库已初始化 |
| 测试步骤 | 1. 访问注册页面<br>2. 填写用户名、邮箱、密码<br>3. 选择角色为"学生"<br>4. 提交注册表单 |
| 预期结果 | 注册成功，返回用户信息，自动创建学生记录 |
| 实际结果 | - |
| 测试状态 | ⏳ 待测试 |

**测试脚本示例：**

```python
# test_auth_register.py
import pytest
from httpx import AsyncClient
from app.main import app

@pytest.mark.asyncio
async def test_student_registration():
    """测试学生注册功能"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        response = await client.post("/api/auth/register", json={
            "username": "test_student_001",
            "email": "student001@test.com",
            "password": "TestPass123!",
            "role": "student",
            "full_name": "测试学生001",
            "student_number": "2024001"
        })
        
        assert response.status_code == 200
        data = response.json()
        assert data["username"] == "test_student_001"
        assert data["role"] == "student"
        assert "password" not in data  # 确保密码不被返回
```

#### 1.2 用户登录

**测试用例：TC-AUTH-002**

| 项目 | 内容 |
|------|------|
| 测试描述 | 验证用户登录功能 |
| 前置条件 | 用户已注册 |
| 测试步骤 | 1. 访问登录页面<br>2. 输入用户名和密码<br>3. 提交登录表单 |
| 预期结果 | 登录成功，返回JWT token和用户信息 |
| 实际结果 | - |
| 测试状态 | ⏳ 待测试 |

**测试脚本示例：**

```python
@pytest.mark.asyncio
async def test_user_login():
    """测试用户登录功能"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        # 先注册一个用户
        await client.post("/api/auth/register", json={
            "username": "login_test_user",
            "email": "logintest@test.com",
            "password": "LoginPass123!",
            "role": "student"
        })
        
        # 测试登录
        response = await client.post("/api/auth/login", data={
            "username": "login_test_user",
            "password": "LoginPass123!"
        })
        
        assert response.status_code == 200
        data = response.json()
        assert "access_token" in data
        assert data["token_type"] == "bearer"
```

#### 1.3 JWT Token验证

**测试用例：TC-AUTH-003**

| 项目 | 内容 |
|------|------|
| 测试描述 | 验证JWT token的有效性 |
| 前置条件 | 用户已登录，获取到token |
| 测试步骤 | 1. 使用token访问受保护的API<br>2. 测试token过期情况<br>3. 测试无效token |
| 预期结果 | 有效token可以访问，无效token返回401 |
| 实际结果 | - |
| 测试状态 | ⏳ 待测试 |

---

### 2. 问卷管理模块

#### 2.1 创建问卷

**测试用例：TC-SURVEY-001**

| 项目 | 内容 |
|------|------|
| 测试描述 | 教师创建新问卷 |
| 前置条件 | 教师已登录 |
| 测试步骤 | 1. 访问问卷创建页面<br>2. 填写问卷标题、描述<br>3. 添加题目（单选、多选、简答等）<br>4. 保存问卷 |
| 预期结果 | 问卷创建成功，状态为"草稿" |
| 实际结果 | - |
| 测试状态 | ⏳ 待测试 |

**测试脚本示例：**

```python
@pytest.mark.asyncio
async def test_create_survey():
    """测试创建问卷功能"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        # 教师登录
        login_response = await client.post("/api/auth/login", data={
            "username": "teacher001",
            "password": "TeacherPass123!"
        })
        token = login_response.json()["access_token"]
        
        # 创建问卷
        response = await client.post(
            "/api/teacher/surveys",
            headers={"Authorization": f"Bearer {token}"},
            json={
                "title": "期中测试问卷",
                "description": "计算机科学基础期中测试",
                "survey_type": "exam",
                "total_score": 100,
                "time_limit": 90,
                "questions": [
                    {
                        "question_type": "single_choice",
                        "question_text": "以下哪个不是Python的数据类型？",
                        "score": 5,
                        "options": ["int", "float", "char", "str"],
                        "correct_answer": "char"
                    }
                ]
            }
        )
        
        assert response.status_code == 200
        data = response.json()
        assert data["title"] == "期中测试问卷"
        assert data["status"] == "draft"
```

#### 2.2 AI自动生成问卷

**测试用例：TC-SURVEY-002**

| 项目 | 内容 |
|------|------|
| 测试描述 | 使用AI从文档生成问卷 |
| 前置条件 | 教师已登录，已上传知识文档 |
| 测试步骤 | 1. 上传Word文档<br>2. 选择生成题目类型和数量<br>3. 点击"AI生成"<br>4. 预览并编辑生成的题目 |
| 预期结果 | AI成功生成题目，可以编辑和调整 |
| 实际结果 | - |
| 测试状态 | ⏳ 待测试 |

**测试数据准备：**

测试文档位于 `uploads/documents/` 目录下，包含5个.docx文件：
- 测试用的课程材料文档
- 包含知识点和示例的文档

**测试脚本示例：**

```python
@pytest.mark.asyncio
async def test_ai_generate_survey():
    """测试AI自动生成问卷功能"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        # 教师登录
        token = await get_teacher_token(client)
        
        # 上传文档
        with open("test_data/sample_course.docx", "rb") as f:
            files = {"file": ("course.docx", f, "application/vnd.openxmlformats-officedocument.wordprocessingml.document")}
            upload_response = await client.post(
                "/api/teacher/documents/upload",
                headers={"Authorization": f"Bearer {token}"},
                files=files,
                data={"course_id": "test_course_id"}
            )
        
        assert upload_response.status_code == 200
        doc_id = upload_response.json()["document_id"]
        
        # AI生成问卷
        response = await client.post(
            "/api/teacher/surveys/generate",
            headers={"Authorization": f"Bearer {token}"},
            json={
                "document_id": doc_id,
                "title": "AI自动生成测试",
                "generation_prompt": "从文档中生成10道单选题",
                "question_types": ["single_choice"],
                "question_count": 10,
                "difficulty": "medium"
            }
        )
        
        assert response.status_code == 200
        data = response.json()
        assert len(data["questions"]) == 10
        assert data["generation_method"] == "ai"
```

#### 2.3 发布问卷

**测试用例：TC-SURVEY-003**

| 项目 | 内容 |
|------|------|
| 测试描述 | 教师发布问卷给学生 |
| 前置条件 | 问卷已创建，状态为"草稿" |
| 测试步骤 | 1. 选择目标班级/学生<br>2. 设置开始和结束时间<br>3. 点击"发布" |
| 预期结果 | 问卷状态变为"已发布"，学生可以看到 |
| 实际结果 | - |
| 测试状态 | ⏳ 待测试 |

---

### 3. 学生答题模块

#### 3.1 查看可用问卷

**测试用例：TC-ANSWER-001**

| 项目 | 内容 |
|------|------|
| 测试描述 | 学生查看可参与的问卷列表 |
| 前置条件 | 学生已登录，有可用问卷 |
| 测试步骤 | 1. 访问问卷列表页面<br>2. 查看问卷信息（标题、截止时间等） |
| 预期结果 | 显示所有可用问卷，包含状态信息 |
| 实际结果 | - |
| 测试状态 | ⏳ 待测试 |

#### 3.2 提交问卷答案

**测试用例：TC-ANSWER-002**

| 项目 | 内容 |
|------|------|
| 测试描述 | 学生提交问卷答案 |
| 前置条件 | 学生已开始答题 |
| 测试步骤 | 1. 回答所有题目<br>2. 点击"提交"<br>3. 确认提交 |
| 预期结果 | 答案成功保存，自动评分（客观题） |
| 实际结果 | - |
| 测试状态 | ⏳ 待测试 |

**测试脚本示例：**

```python
@pytest.mark.asyncio
async def test_submit_survey_answers():
    """测试学生提交问卷答案"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        # 学生登录
        token = await get_student_token(client)
        
        # 获取可用问卷
        surveys_response = await client.get(
            "/api/student/surveys",
            headers={"Authorization": f"Bearer {token}"}
        )
        survey_id = surveys_response.json()[0]["id"]
        
        # 开始答题
        start_response = await client.post(
            f"/api/student/surveys/{survey_id}/start",
            headers={"Authorization": f"Bearer {token}"}
        )
        response_id = start_response.json()["response_id"]
        
        # 提交答案
        submit_response = await client.post(
            f"/api/student/surveys/{survey_id}/submit",
            headers={"Authorization": f"Bearer {token}"},
            json={
                "response_id": response_id,
                "answers": [
                    {
                        "question_id": "q1_id",
                        "answer": "A"
                    },
                    {
                        "question_id": "q2_id",
                        "answer": ["A", "B"]
                    }
                ]
            }
        )
        
        assert submit_response.status_code == 200
        result = submit_response.json()
        assert "total_score" in result
        assert result["status"] == "submitted"
```

---

### 4. AI问答模块

#### 4.1 提问功能

**测试用例：TC-QA-001**

| 项目 | 内容 |
|------|------|
| 测试描述 | 学生向AI提问 |
| 前置条件 | 学生已登录，知识库已构建 |
| 测试步骤 | 1. 输入问题<br>2. 点击"提问"<br>3. 等待AI回答 |
| 预期结果 | AI返回相关答案，包含来源文档引用 |
| 实际结果 | - |
| 测试状态 | ⏳ 待测试 |

**测试脚本示例：**

```python
@pytest.mark.asyncio
async def test_qa_ask_question():
    """测试AI问答功能"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        token = await get_student_token(client)
        
        response = await client.post(
            "/api/student/qa/ask",
            headers={"Authorization": f"Bearer {token}"},
            json={
                "question": "什么是面向对象编程？",
                "course_id": "test_course_id"
            }
        )
        
        assert response.status_code == 200
        data = response.json()
        assert "answer" in data
        assert "sources" in data
        assert len(data["sources"]) > 0
```

#### 4.2 历史记录

**测试用例：TC-QA-002**

| 项目 | 内容 |
|------|------|
| 测试描述 | 查看问答历史记录 |
| 前置条件 | 学生已提问过 |
| 测试步骤 | 1. 访问历史记录页面<br>2. 查看之前的问题和答案 |
| 预期结果 | 显示所有历史问答记录 |
| 实际结果 | - |
| 测试状态 | ⏳ 待测试 |

---

### 5. 教师仪表盘模块

#### 5.1 数据统计

**测试用例：TC-DASHBOARD-001**

| 项目 | 内容 |
|------|------|
| 测试描述 | 查看学生答题统计 |
| 前置条件 | 教师已登录，有学生提交答案 |
| 测试步骤 | 1. 访问仪表盘<br>2. 查看统计图表 |
| 预期结果 | 显示提交率、平均分、分数分布等 |
| 实际结果 | - |
| 测试状态 | ⏳ 待测试 |

**测试脚本示例：**

```python
@pytest.mark.asyncio
async def test_dashboard_statistics():
    """测试教师仪表盘统计功能"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        token = await get_teacher_token(client)
        
        response = await client.get(
            "/api/teacher/dashboard/statistics",
            headers={"Authorization": f"Bearer {token}"},
            params={"survey_id": "test_survey_id"}
        )
        
        assert response.status_code == 200
        data = response.json()
        assert "total_students" in data
        assert "submitted_count" in data
        assert "average_score" in data
        assert "score_distribution" in data
```

---

## API测试

### API测试清单

| API端点 | 方法 | 描述 | 测试状态 |
|---------|------|------|---------|
| `/api/auth/register` | POST | 用户注册 | ⏳ |
| `/api/auth/login` | POST | 用户登录 | ⏳ |
| `/api/teacher/surveys` | GET | 获取问卷列表 | ⏳ |
| `/api/teacher/surveys` | POST | 创建问卷 | ⏳ |
| `/api/teacher/surveys/{id}` | PUT | 更新问卷 | ⏳ |
| `/api/teacher/surveys/{id}` | DELETE | 删除问卷 | ⏳ |
| `/api/teacher/surveys/{id}/publish` | POST | 发布问卷 | ⏳ |
| `/api/teacher/documents/upload` | POST | 上传文档 | ⏳ |
| `/api/teacher/surveys/generate` | POST | AI生成问卷 | ⏳ |
| `/api/student/surveys` | GET | 获取可用问卷 | ⏳ |
| `/api/student/surveys/{id}/start` | POST | 开始答题 | ⏳ |
| `/api/student/surveys/{id}/submit` | POST | 提交答案 | ⏳ |
| `/api/student/qa/ask` | POST | AI问答 | ⏳ |
| `/api/teacher/dashboard/statistics` | GET | 获取统计数据 | ⏳ |

### Postman测试集合

创建Postman测试集合，包含以下内容：

1. **环境变量配置**
   ```json
   {
     "base_url": "http://localhost:8000",
     "teacher_token": "",
     "student_token": "",
     "survey_id": "",
     "response_id": ""
   }
   ```

2. **预请求脚本**（自动获取token）
   ```javascript
   // 在需要认证的请求中添加
   pm.request.headers.add({
     key: 'Authorization',
     value: 'Bearer ' + pm.environment.get('teacher_token')
   });
   ```

3. **测试脚本**（验证响应）
   ```javascript
   // 验证状态码
   pm.test("Status code is 200", function () {
     pm.response.to.have.status(200);
   });
   
   // 验证响应结构
   pm.test("Response has required fields", function () {
     var jsonData = pm.response.json();
     pm.expect(jsonData).to.have.property('id');
     pm.expect(jsonData).to.have.property('title');
   });
   ```

---

## 性能测试

### 负载测试

#### 并发用户测试

**测试场景：100个并发用户同时提交问卷**

```python
# test_performance.py
import asyncio
import time
from httpx import AsyncClient

async def submit_survey_concurrent(user_id: int):
    """模拟单个用户提交问卷"""
    async with AsyncClient(base_url="http://localhost:8000") as client:
        start_time = time.time()
        
        # 登录
        login_response = await client.post("/api/auth/login", data={
            "username": f"student{user_id}",
            "password": "TestPass123!"
        })
        token = login_response.json()["access_token"]
        
        # 提交答案
        await client.post(
            f"/api/student/surveys/{survey_id}/submit",
            headers={"Authorization": f"Bearer {token}"},
            json={"answers": test_answers}
        )
        
        end_time = time.time()
        return end_time - start_time

async def test_concurrent_submissions():
    """测试100个并发提交"""
    tasks = [submit_survey_concurrent(i) for i in range(100)]
    response_times = await asyncio.gather(*tasks)
    
    avg_time = sum(response_times) / len(response_times)
    max_time = max(response_times)
    min_time = min(response_times)
    
    print(f"平均响应时间: {avg_time:.2f}秒")
    print(f"最大响应时间: {max_time:.2f}秒")
    print(f"最小响应时间: {min_time:.2f}秒")
    
    # 验证性能指标
    assert avg_time < 2.0, "平均响应时间超过2秒"
    assert max_time < 5.0, "最大响应时间超过5秒"
```

### 压力测试

使用 **Locust** 进行压力测试：

```python
# locustfile.py
from locust import HttpUser, task, between

class StudentUser(HttpUser):
    wait_time = between(1, 3)
    
    def on_start(self):
        """登录获取token"""
        response = self.client.post("/api/auth/login", data={
            "username": "test_student",
            "password": "TestPass123!"
        })
        self.token = response.json()["access_token"]
    
    @task(3)
    def get_surveys(self):
        """获取问卷列表"""
        self.client.get("/api/student/surveys", headers={
            "Authorization": f"Bearer {self.token}"
        })
    
    @task(1)
    def submit_survey(self):
        """提交问卷"""
        self.client.post(
            "/api/student/surveys/test_id/submit",
            headers={"Authorization": f"Bearer {self.token}"},
            json={"answers": []}
        )
```

运行压力测试：
```bash
locust -f locustfile.py --host=http://localhost:8000
```

---

## 安全测试

### 认证与授权测试

#### 1. 未授权访问测试

**测试用例：SEC-001**

```python
@pytest.mark.asyncio
async def test_unauthorized_access():
    """测试未授权访问受保护的API"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        # 不提供token访问受保护的API
        response = await client.get("/api/teacher/surveys")
        assert response.status_code == 401
        
        # 使用无效token
        response = await client.get(
            "/api/teacher/surveys",
            headers={"Authorization": "Bearer invalid_token"}
        )
        assert response.status_code == 401
```

#### 2. 权限验证测试

**测试用例：SEC-002**

```python
@pytest.mark.asyncio
async def test_role_based_access():
    """测试基于角色的访问控制"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        # 学生token
        student_token = await get_student_token(client)
        
        # 学生尝试访问教师API
        response = await client.post(
            "/api/teacher/surveys",
            headers={"Authorization": f"Bearer {student_token}"},
            json={"title": "Unauthorized Survey"}
        )
        assert response.status_code == 403  # Forbidden
```

### SQL注入测试

**测试用例：SEC-003**

```python
@pytest.mark.asyncio
async def test_sql_injection_protection():
    """测试SQL注入防护"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        # 尝试SQL注入
        response = await client.post("/api/auth/login", data={
            "username": "admin' OR '1'='1",
            "password": "anything"
        })
        assert response.status_code == 401  # 应该登录失败
```

### XSS攻击测试

**测试用例：SEC-004**

```python
@pytest.mark.asyncio
async def test_xss_protection():
    """测试XSS攻击防护"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        token = await get_teacher_token(client)
        
        # 尝试注入脚本标签
        response = await client.post(
            "/api/teacher/surveys",
            headers={"Authorization": f"Bearer {token}"},
            json={
                "title": "<script>alert('XSS')</script>",
                "description": "<img src=x onerror=alert('XSS')>"
            }
        )
        
        # 验证响应中的脚本被转义或过滤
        data = response.json()
        assert "<script>" not in data["title"]
        assert "onerror" not in data["description"]
```

---

## 测试数据准备

### 测试用户数据

创建测试用户的脚本：

```python
# scripts/create_test_users.py
import asyncio
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker
from app.models.user import User
from app.utils.auth import get_password_hash

async def create_test_users():
    """创建测试用户"""
    engine = create_async_engine("postgresql+asyncpg://...")
    async_session = sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)
    
    async with async_session() as session:
        # 创建10个学生
        for i in range(1, 11):
            user = User(
                username=f"student{i:03d}",
                email=f"student{i}@test.com",
                password_hash=get_password_hash("TestPass123!"),
                role="student",
                full_name=f"测试学生{i:03d}"
            )
            session.add(user)
        
        # 创建3个教师
        for i in range(1, 4):
            user = User(
                username=f"teacher{i:03d}",
                email=f"teacher{i}@test.com",
                password_hash=get_password_hash("TeacherPass123!"),
                role="teacher",
                full_name=f"测试教师{i:03d}"
            )
            session.add(user)
        
        await session.commit()
    
    print("测试用户创建完成！")

if __name__ == "__main__":
    asyncio.run(create_test_users())
```

### 测试问卷数据

```python
# scripts/create_test_surveys.py
async def create_test_survey():
    """创建测试问卷"""
    survey_data = {
        "title": "Python基础测试",
        "description": "测试Python基础知识掌握情况",
        "survey_type": "exam",
        "total_score": 100,
        "time_limit": 60,
        "questions": [
            {
                "question_type": "single_choice",
                "question_text": "Python是什么类型的语言？",
                "score": 10,
                "options": ["编译型", "解释型", "汇编型", "机器语言"],
                "correct_answer": "解释型"
            },
            # ... 更多题目
        ]
    }
    
    # 创建问卷...
```

### 清理测试数据

使用提供的SQL脚本清理数据：

```bash
psql -U postgres -d teaching_platform_test -f backend/database/clear_data.sql
```

或使用Python脚本：

```python
# scripts/clear_test_data.py
import asyncio
from sqlalchemy.ext.asyncio import create_async_engine

async def clear_all_data():
    """清空所有测试数据"""
    engine = create_async_engine("postgresql+asyncpg://...")
    
    async with engine.begin() as conn:
        # 按照外键依赖顺序删除
        await conn.execute("TRUNCATE TABLE answers CASCADE")
        await conn.execute("TRUNCATE TABLE survey_responses CASCADE")
        await conn.execute("TRUNCATE TABLE questions CASCADE")
        await conn.execute("TRUNCATE TABLE surveys CASCADE")
        await conn.execute("TRUNCATE TABLE class_students CASCADE")
        await conn.execute("TRUNCATE TABLE classes CASCADE")
        await conn.execute("TRUNCATE TABLE courses CASCADE")
        await conn.execute("TRUNCATE TABLE students CASCADE")
        await conn.execute("TRUNCATE TABLE teachers CASCADE")
        await conn.execute("TRUNCATE TABLE users CASCADE")
    
    print("所有测试数据已清空！")

if __name__ == "__main__":
    asyncio.run(clear_all_data())
```

---

## 常见问题与解决方案

### 1. 数据库连接问题

**问题描述**：无法连接到PostgreSQL数据库

**解决方案**：
```bash
# 检查PostgreSQL服务状态
sudo systemctl status postgresql  # Linux
brew services list  # macOS
Get-Service postgresql-x64-14  # Windows

# 检查连接字符串
# 确保 DATABASE_URL 配置正确
# postgresql://username:password@host:port/database
```

### 2. 向量数据库初始化失败

**问题描述**：ChromaDB初始化错误

**解决方案**：
```bash
# 清空ChromaDB目录
rm -rf backend/data/chroma_db/*
rm -rf data/chroma_db/*

# 重新初始化
python backend/app/utils/vector_db_manager.py
```

### 3. Token过期问题

**问题描述**：测试中token过期导致401错误

**解决方案**：
```python
# 在测试中设置更长的过期时间
ACCESS_TOKEN_EXPIRE_MINUTES = 60  # 测试环境使用更长时间

# 或在每次请求前刷新token
@pytest.fixture
async def fresh_token():
    # 每次都获取新token
    async with AsyncClient(app=app) as client:
        response = await client.post("/api/auth/login", ...)
        return response.json()["access_token"]
```

### 4. 文档解析失败

**问题描述**：上传的Word文档无法解析

**解决方案**：
```python
# 检查文档格式
# 确保文档是.docx格式（不是.doc）
# 检查文档是否损坏

# 安装必要的依赖
pip install python-docx mammoth

# 查看日志获取详细错误信息
```

### 5. AI生成问卷失败

**问题描述**：AI无法生成题目

**解决方案**：
```bash
# 检查OpenAI API配置
echo $OPENAI_API_KEY

# 检查向量数据库是否有数据
python -c "from app.utils.vector_db_manager import VectorDBManager; \
           manager = VectorDBManager(); \
           print(manager.collection.count())"

# 检查文档是否已正确索引
```

---

## 测试回退与恢复

### Git版本控制

所有测试文件都已被删除，但可以通过Git回退：

```bash
# 查看git状态
git status

# 回退所有更改（恢复删除的文件）
git checkout -- .

# 或恢复特定文件
git checkout -- backend/check_surveys.py

# 查看删除记录
git log --diff-filter=D --summary
```

### 数据库备份与恢复

#### 备份数据库

```bash
# 备份整个数据库
pg_dump -U postgres -d teaching_platform > backup_$(date +%Y%m%d_%H%M%S).sql

# 只备份数据（不包括结构）
pg_dump -U postgres -d teaching_platform --data-only > data_backup.sql

# 备份特定表
pg_dump -U postgres -d teaching_platform -t surveys -t questions > surveys_backup.sql
```

#### 恢复数据库

```bash
# 从备份恢复
psql -U postgres -d teaching_platform < backup_20260128_120000.sql

# 恢复数据
psql -U postgres -d teaching_platform < data_backup.sql
```

### 向量数据库备份

```bash
# 备份ChromaDB
cp -r backend/data/chroma_db backend/data/chroma_db_backup_$(date +%Y%m%d)
cp -r data/chroma_db data/chroma_db_backup_$(date +%Y%m%d)

# 恢复ChromaDB
rm -rf backend/data/chroma_db
cp -r backend/data/chroma_db_backup_20260128 backend/data/chroma_db
```

### 文件备份

```bash
# 备份uploads目录
tar -czf uploads_backup_$(date +%Y%m%d).tar.gz uploads/

# 恢复文件
tar -xzf uploads_backup_20260128.tar.gz
```

---

## 测试执行命令

### 运行所有测试

```bash
# 后端测试
cd backend
pytest tests/ -v --cov=app --cov-report=html

# 前端测试
cd frontend
npm test

# E2E测试
npm run test:e2e
```

### 运行特定测试

```bash
# 运行特定测试文件
pytest tests/test_auth.py -v

# 运行特定测试函数
pytest tests/test_auth.py::test_user_login -v

# 运行带标记的测试
pytest -m "not slow" -v
```

### 生成测试报告

```bash
# HTML覆盖率报告
pytest --cov=app --cov-report=html
# 报告位于 htmlcov/index.html

# JUnit XML报告（用于CI/CD）
pytest --junitxml=test-results.xml

# 详细测试报告
pytest -v --html=report.html --self-contained-html
```

---

## 持续集成配置

### GitHub Actions示例

创建 `.github/workflows/test.yml`:

```yaml
name: Tests

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: Run tests
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
      run: |
        cd backend
        pytest tests/ -v --cov=app
    
  frontend-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '16'
    
    - name: Install dependencies
      run: |
        cd frontend
        npm install
    
    - name: Run tests
      run: |
        cd frontend
        npm test
```

---

## 附录

### 测试检查清单

- [ ] 所有API端点都有测试用例
- [ ] 测试覆盖率达到80%以上
- [ ] 所有关键功能都有集成测试
- [ ] 性能测试通过
- [ ] 安全测试无高危漏洞
- [ ] 文档与代码保持同步
- [ ] CI/CD流程正常运行

### 参考资源

- [FastAPI测试文档](https://fastapi.tiangolo.com/tutorial/testing/)
- [pytest官方文档](https://docs.pytest.org/)
- [React Testing Library](https://testing-library.com/docs/react-testing-library/intro/)
- [Postman测试指南](https://learning.postman.com/docs/writing-scripts/test-scripts/)

---

## 更新日志

| 版本 | 日期 | 更新内容 | 作者 |
|------|------|----------|------|
| v1.0.0 | 2026-01-28 | 初始版本，包含完整测试流程 | 开发团队 |

---

**文档结束**
