# 文档上传与知识点提取功能使用指南

## 功能概述

本系统实现了完整的课程文档上传、知识点自动提取和知识图谱构建功能，支持：

✅ **课程大纲上传** - 上传课程大纲，自动提取章节结构
✅ **课程资料上传** - 上传课程相关资料文档  
✅ **智能知识点提取** - 自动识别定义、概念、列表、特征等知识点
✅ **无限制文本处理** - 不限制文档长度，完整解析所有内容
✅ **实时进度追踪** - 前后端同步的处理进度条
✅ **知识图谱构建** - 自动构建知识点关系图谱
✅ **多格式支持** - PDF, Word (docx/doc), TXT, PPT/PPTX

## 使用步骤

### 1. 数据库迁移

首先需要执行数据库迁移脚本来创建必要的表结构：

```bash
cd f:\sjtu_project\project\backend

# 启动PostgreSQL数据库（如果还未启动）

# 执行迁移
python run_migrations.py
```

迁移脚本会创建以下表：
- `knowledge_points` - 知识点表
- `knowledge_relations` - 知识点关系表  
- `knowledge_graphs` - 知识图谱元数据表
- `document_processing_tasks` - 文档处理任务表

### 2. 启动后端服务

```bash
cd f:\sjtu_project\project\backend
python app/main.py
```

后端服务将在 `http://localhost:8000` 启动。

新增的API端点：
- `POST /api/teacher/courses/{course_id}/documents/upload` - 上传文档
- `GET /api/teacher/courses/{course_id}/documents` - 获取文档列表
- `GET /api/teacher/documents/{document_id}/progress` - 获取处理进度
- `GET /api/teacher/courses/{course_id}/knowledge-graph` - 获取知识图谱
- `DELETE /api/teacher/documents/{document_id}` - 删除文档

### 3. 启动前端服务

```bash
cd f:\sjtu_project\project\frontend
npm run dev
```

前端将在 `http://localhost:5173` 启动。

### 4. 在前端页面中使用上传组件

在需要上传文档的页面导入并使用 `DocumentUpload` 组件：

```typescript
import DocumentUpload from '@/components/DocumentUpload';

function CoursePage() {
  const courseId = "your-course-id";
  
  return (
    <div>
      <h2>上传课程资料</h2>
      <DocumentUpload 
        courseId={courseId}
        onUploadComplete={() => {
          console.log('上传完成！');
          // 刷新文档列表等操作
        }}
      />
    </div>
  );
}
```

## 文档上传流程

### 用户操作流程

1. **选择文档类型**
   - 课程大纲 (outline) - 用于课程结构和章节提取
   - 课程资料 (material) - 用于补充知识点内容

2. **上传文件**
   - 拖拽文件到上传区域，或点击选择文件
   - 支持同时上传多个文件
   - 支持格式：PDF, Word, TXT, PPT

3. **实时查看进度**
   - 上传进度：0-100%（文件传输）
   - 处理进度：0-100%（知识点提取，6个步骤）
     * 步骤1：提取文本 (0-20%)
     * 步骤2：分割章节 (20-30%)
     * 步骤3：提取知识点 (30-70%)
     * 步骤4：提取关键词 (70-80%)
     * 步骤5：保存知识点 (80-90%)
     * 步骤6：构建知识图谱 (90-100%)

### 后台处理流程

```
文件上传 → 创建文档记录 → 后台任务启动
                            ↓
                    知识点提取器 (KnowledgePointExtractor)
                            ↓
            1. 提取文本 (PDF/Word/TXT)
            2. 智能分割章节
            3. 识别知识点（定义、列表、特征等）
            4. 提取关键词
            5. 保存到数据库
            6. 构建知识关系图谱
                            ↓
                        处理完成
```

## 知识点提取示例

假设上传以下内容的课程大纲：

```text
第一章 操作系统概述

1.1 操作系统的定义
操作系统是管理计算机硬件和软件资源的程序。

1.2 操作系统的功能
- 进程管理：负责进程的创建、调度和终止
- 内存管理：负责内存的分配和回收
```

系统会自动提取：

**章节结构：**
- 第一章 操作系统概述
  - 1.1 操作系统的定义
  - 1.2 操作系统的功能

**知识点：**
1. [定义] 操作系统 - 管理计算机硬件和软件资源的程序
2. [列表] 进程管理 - 负责进程的创建、调度和终止
3. [列表] 内存管理 - 负责内存的分配和回收

**关键词：**
操作系统、进程管理、内存管理、硬件、软件

## API使用示例

### 1. 上传文档

```typescript
import { uploadDocument } from '@/services/documents';

const handleUpload = async (file: File, courseId: string) => {
  try {
    const result = await uploadDocument(
      courseId,
      file,
      'outline', // 或 'material'
      (progress) => {
        console.log(`上传进度: ${progress}%`);
      }
    );
    
    console.log('文档ID:', result.document_id);
    // 开始轮询处理进度
  } catch (error) {
    console.error('上传失败:', error);
  }
};
```

### 2. 查询处理进度

```typescript
import { getDocumentProgress } from '@/services/documents';

const checkProgress = async (documentId: string) => {
  const progress = await getDocumentProgress(documentId);
  
  console.log({
    status: progress.status,           // pending/processing/completed/failed
    progress: progress.progress,       // 0-100
    currentStep: progress.current_step,
    totalSteps: progress.total_steps
  });
};
```

### 3. 获取知识图谱

```typescript
import { getCourseKnowledgeGraph } from '@/services/documents';

const loadKnowledgeGraph = async (courseId: string) => {
  const graph = await getCourseKnowledgeGraph(courseId);
  
  console.log({
    nodes: graph.nodes,  // 知识点节点
    edges: graph.edges,  // 知识点关系
    statistics: graph.statistics  // 统计信息
  });
  
  // 用于可视化渲染
  renderGraph(graph.nodes, graph.edges);
};
```

## 数据库结构

### knowledge_points 表
```sql
id              UUID (主键)
course_id       UUID (课程ID)
document_id     UUID (文档ID)
point_name      VARCHAR(500) (知识点名称)
point_content   TEXT (知识点内容)
point_type      VARCHAR(50) (类型：concept/method/example等)
level           INTEGER (层级)
parent_id       UUID (父知识点)
keywords        TEXT[] (关键词数组)
difficulty      VARCHAR(20) (难度)
importance      INTEGER (重要程度1-5)
```

### knowledge_relations 表
```sql
id                 UUID (主键)
source_point_id    UUID (源知识点)
target_point_id    UUID (目标知识点)
relation_type      VARCHAR(50) (关系类型：prerequisite/related/includes等)
relation_strength  DECIMAL (关系强度0-1)
```

### document_processing_tasks 表
```sql
id              UUID (主键)
document_id     UUID (文档ID)
task_type       VARCHAR(50) (任务类型)
status          VARCHAR(20) (状态)
progress        INTEGER (进度0-100)
current_step    INTEGER (当前步骤)
total_steps     INTEGER (总步骤数)
```

## 核心功能特点

### 1. 无限制处理
- ✅ 不限制文档大小
- ✅ 不限制文本长度
- ✅ 完整解析所有内容
- ✅ 不会截断或跳过任何知识点

### 2. 智能识别
- 章节标题（多种格式）
- 定义和概念
- 列表和要点
- 示例和案例
- 特征和特点

### 3. 进度同步
- 实时更新处理进度
- 前后端进度一致
- 分6个步骤追踪
- 显示当前处理阶段

### 4. 错误处理
- 文件格式验证
- 权限检查
- 异常捕获
- 友好错误提示

## 注意事项

1. **数据库连接**：确保PostgreSQL服务已启动且配置正确
2. **文件权限**：确保uploads/documents目录有写入权限
3. **依赖包**：需要安装PyPDF2、python-docx等依赖
4. **大文件上传**：虽然无限制，但建议单个文件不超过100MB以保证性能
5. **并发处理**：多个文档同时上传时会按顺序处理

## 故障排查

### 问题：数据库迁移失败
**解决：** 
- 检查PostgreSQL是否启动
- 验证数据库连接配置
- 查看migrate_knowledge_system.sql是否有语法错误

### 问题：文件上传失败
**解决：**
- 检查uploads/documents目录权限
- 验证文件格式是否支持
- 查看后端日志错误信息

### 问题：知识点提取没有结果
**解决：**
- 检查文档内容格式
- 验证文档是否有可识别的结构
- 查看document_processing_tasks表的error_message

## 后续扩展

可以进一步扩展的功能：
- [ ] 知识图谱可视化界面
- [ ] 知识点手动编辑
- [ ] 导出知识图谱为图片
- [ ] AI增强的知识点关系推理
- [ ] 知识点难度自动评估
- [ ] 学习路径推荐

---

**开发完成时间：** 2026年2月4日
**版本：** 1.0.0
